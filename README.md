# Boas-vindas ao reposit√≥rio do projeto API de Blogs!

Aqui voc√™ vai encontrar os detalhes de como foi estruturar o desenvolvimento do projeto a partir deste reposit√≥rio.

<br />
# Entreg√°veis

<details>
  <summary><strong>üë®‚Äçüíª O que foi desenvolvido</strong></summary>

  Desenvolvimento de uma API e um banco de dados para a produ√ß√£o de conte√∫do para um blog! 

  Aplica√ß√£o em `Node.js` usando o pacote `sequelize` para fazer um `CRUD` de posts.

  1. Constru√ß√£o de endpoints que estar√£o conectados ao seu banco de dados seguindo os princ√≠pios do REST;

  2. Para fazer um post √© necess√°rio usu√°rio e login, portanto foi trabalhada a **rela√ß√£o entre** `user` e `post`; 

  3. Ser√° necess√°ria a utiliza√ß√£o de categorias para os posts, trabalhando, assim, a **rela√ß√£o de** `posts` para `categories` e de `categories` para `posts`.

<br />
</details>

<br />

# Orienta√ß√µes

<details>
  <summary><strong>üêã Rodando no Docker vs Localmente</strong></summary>
  
  ## üëâ Com Docker
 
  **:warning: Antes de come√ßar, seu docker-compose precisa estar na vers√£o 1.29 ou superior. [Veja aqui](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-ubuntu-20-04-pt) ou [na documenta√ß√£o](https://docs.docker.com/compose/install/) como instal√°-lo. No primeiro artigo, voc√™ pode substituir onde est√° com `1.26.0` por `1.29.2`.**


  > :information_source: Rode os servi√ßos `node` e `db` com o comando `docker-compose up -d --build`.

  - Lembre-se de parar o `mysql` se estiver usando localmente na porta padr√£o (`3306`), ou adapte, caso queria fazer uso da aplica√ß√£o em containers;

  - Esses servi√ßos ir√£o inicializar um container chamado `blogs_api` e outro chamado `blogs_api_db`;

  - A partir daqui voc√™ pode rodar o container `blogs_api` via CLI ou abri-lo no VS Code;

  > :information_source: Use o comando `docker exec -it blogs_api bash`.

  - Ele te dar√° acesso ao terminal interativo do container criado pelo compose, que est√° rodando em segundo plano.

  > :information_source: Instale as depend√™ncias [**Caso existam**] com `npm install`. (Instale dentro do container)
  
  - **:warning: Aten√ß√£o:** Caso opte por utilizar o Docker, **TODOS** os comandos dispon√≠veis no `package.json` (npm start, npm test, npm run dev, ...) devem ser executados **DENTRO** do container, ou seja, no terminal que aparece ap√≥s a execu√ß√£o do comando `docker exec` citado acima. 

  - **:warning: Aten√ß√£o:** O **git** dentro do container n√£o vem configurado com suas credenciais. Ou fa√ßa os commits fora do container, ou configure as suas credenciais do git dentro do container.

  - **:warning: Aten√ß√£o:** N√£o rode o comando npm audit fix! Ele atualiza v√°rias depend√™ncias do projeto, e essa atualiza√ß√£o gera conflitos com o avaliador.

  - ‚ú® **Dica:** A extens√£o `Remote - Containers` (que estar√° na se√ß√£o de extens√µes recomendadas do VS Code) √© indicada para que voc√™ possa desenvolver sua aplica√ß√£o no container Docker direto no VS Code, como voc√™ faz com seus arquivos locais.

  ![sequelize test](./public/remote-container.png)

  <br />
  
  ## üëâ Sem Docker

  > :information_source: Instale as depend√™ncias [**Caso existam**] com `npm install`
  
  - **:warning: Aten√ß√£o:** N√£o rode o comando npm audit fix! Ele atualiza v√°rias depend√™ncias do projeto, e essa atualiza√ß√£o gera conflitos com o avaliador.

  - **‚ú® Dica:** Para rodar o projeto desta forma, obrigatoriamente voc√™ deve ter o `node` instalado em seu computador.
  - **‚ú® Dica:** O avaliador espera que a vers√£o do `node` utilizada seja a 16.

  <br/>
</details>


<details>
  <summary><strong>‚ÄºÔ∏è Antes de come√ßar a desenvolver</strong></summary>

1. Clone o reposit√≥rio
  * `git clone git@github.com:p4n1k0r/project-blogs-api.git`.
  * Entre na pasta do reposit√≥rio que voc√™ acabou de clonar:
    * `cd project-blogs-api`

2. Instale as depend√™ncias [**Caso existam**]
  * `npm install`

<br />
</details>

<details>
  <summary><strong>üõ† Execu√ß√£o de testes localmente</strong></summary>

  > :information_source: IMPORTANTE

  - O teste local deve rodar o script `npm run start:test`, que vai iniciar e depois encerrar, em segundo plano **outra inst√¢ncia da sua API, na porta `3030`**. Dessa forma, o teste conseguira consumir sua API e validar os requisitos.

  - Sua API deve estar funcionando minimamente para que o teste comece, dado que ele aguarda o estabelecimento da mesma para come√ßar o teste.

  - Todos os testes **v√£o gerar e consumir um banco de dados pr√≥prio com final `*-test`**, que √© gerado atrav√©s da configura√ß√£o do arquivo `src/database/config/config.js`.

  - Isso vai garantir que durante seu desenvolvimento, o teste n√£o manipule ou derrube sua API na porta padr√£o (`3000`) ou seu banco de dados padr√£o (final `*-dev`), isolando os mesmos.

  - Caso ocorra algum problema, encerre o teste com `[CTRL] + [C]` e utilize o script `npm run kill:test`

  ---

  O teste local j√° √© configurado, internamente, com a vari√°vel de ambiente `NODE_ENV=test` para indicar o banco a ser utilizado pelo Sequelize, o que deve resultar na cria√ß√£o de um banco, somente para o teste:

  ![sequelize test](./public/sequelize-02.png)

  Sem essa vari√°vel (modo padr√£o de desenvolvimento), sua API deve resultar algo como:

  ![sequelize development](./public/sequelize-01.png)

  ---

  > :information_source: Scripts para executar os testes locais:

  Vamos usar o Jest para executar os testes, use o comando a seguir para executar todos os testes: 

  ```sh
  npm test
  ```

  Caso queira executar s√≥ um arquivo de test use o seguinte comando, considerado que quer testar o arquivo `tests/req07-createPost.test.js`:

  ```sh
  npm test tests/req07-createPost.test.js
  ```
  ou
  ```
  npm test req07
  ```

  Caso queira omitir dados de debug nos testes, utilize a vari√°vel de ambiente `DEBUG=false`, como em `DEBUG=false npm test`.

  Obs: __tests__ criados pelo time da trybe

<br />
</details>

<details>
  <summary><strong>‚ö†Ô∏è Informa√ß√µes importantes sobre o projeto</strong></summary>

  ## ‚ö†Ô∏è Leia-os atentamente e siga √† risca o que for pedido. ‚ö†Ô∏è

  ### üëÄ Observa√ß√µes importantes:

  Em cada requisito voc√™ encontrar√° uma imagem demonstrando como sua API dever√° se comportar, dada a requisi√ß√£o espec√≠fica.

  O n√£o cumprimento de um requisito, total ou parcialmente, impactar√° em sua avalia√ß√£o.

  O projeto possui uma pasta `src`, e √© **fortemente recomend√°vel que voc√™ construa sua aplica√ß√£o dentro dessa pasta**.

  **N√£o √© necess√°rio usar o comando `npx sequelize-cli init`** uma vez que j√° √© fornecido no projeto.

  #### Arquivos importantes

  ‚ö†Ô∏è Essa pasta ainda conta com alguns arquivos auxiliares que ser√£o consumidos pelo avaliador e **n√£o devem ser apagados em nenhuma hip√≥tese**:

  > `src/api.js`
  ```javascript
  const express = require('express');

  // ...

  const app = express();

  app.use(express.json());

  // ...

  // √â importante exportar a constante `app`, 
  // para que possa ser utilizada pelo arquivo `src/server.js`
  module.exports = app;
  ```
  Que ficar√° respons√°vel por receber **as defini√ß√µes de middlewares e rotas** de sua API

  <br />

  ---

  > üëâ `src/server.js`
  ```javascript
  const app = require('./api');

  // n√£o remova a vari√°vel `API_PORT` ou o `listen`
  const port = process.env.API_PORT || 3000;

  // n√£o remova esse endpoint
  app.get('/', (request, response) => {
    response.send();
  });

  app.listen(port, () => console.log('ouvindo porta', port));
  ```
  Que ficar√° respons√°vel por iniciar sua API

  <br />

  ---

  > üëâ `src/database/config/config.js`
  ```javascript
  require('dotenv').config();

  const environment = process.env.NODE_ENV || 'test';

  const suffix = {
    dev: '-dev',
    development: '-dev',
    test: '-test',
  };

  const options = {
    host: process.env.HOSTNAME || process.env.MYSQL_HOST || 'localhost',
    port: process.env.MYSQL_PORT || '3306',
    database: 
      `${process.env.MYSQL_DB_NAME || 'blogs-api'}${suffix[environment] || suffix.test}`,
    username: process.env.MYSQL_USER || 'root',
    password: process.env.MYSQL_PASSWORD || '1234',
    dialect: 'mysql',
    dialectOptions: {
      timezone: 'Z',
    },
    logging: process.env.DEBUG !== 'false',
  };

  module.exports = {
    development: {
      ...options,
    },
    test: {
      ...options,
    },
  };
  ```
  Que √© o arquivo de configura√ß√£o principal do *Sequelize*

  <br />

  ---

  > üëâ `.sequelizerc`
  ```javascript
  const path = require('path');

  module.exports = {
    'config': path.resolve('src', 'database', 'config', 'config.js'),
    'models-path': path.resolve('src', 'database', 'models'),
    'seeders-path': path.resolve('src', 'database', 'seeders'),
    'migrations-path': path.resolve('src', 'database', 'migrations'),
  };
  ```
  Respons√°vel por identificar os caminhos dos recursos do Sequelize

  <br />

  ---

  **Voc√™ ir√° precisar configurar as vari√°veis de ambiente para uso do MySQL.** Voc√™ pode usar esse [Conte√∫do de vari√°veis de ambiente com NodeJS](https://dev.to/pauloricardoz/usando-variaveis-de-ambiente-em-nodejs-env--4ioi) como refer√™ncia.

  O arquivo a seguir, cont√©m um modelo das vari√°veis de ambiente utilizadas no projeto. Para o contexto de teste local, √© importante configurar as vari√°veis: `MYSQL_HOST`, `MYSQL_PORT`, `MYSQL_USER`, `MYSQL_PASSWORD`:

  > üëâ `.env.example`
  ```env
  #### SERVER VARS
  NODE_ENV=development
  API_PORT=3000

  #### DATABASE VARS
  MYSQL_HOST=localhost
  MYSQL_PORT=3306
  MYSQL_DB_NAME=blogs-api
  MYSQL_USER=root
  MYSQL_PASSWORD=password

  #### SECRECT VARS
  JWT_SECRET=suaSenhaSecreta
  ```

  #### Vari√°vel `JWT_SECRET`:
  
  Esta vari√°vel de ambiente dever√° ser utilizada tanto para criar o token quanto para verific√°-lo. Os teste locais e o avaliador v√£o utilizar a vari√°vel de ambiente `JWT_SECRET` para testar os requisitos

  **:warning:Ô∏è Vari√°veis de ambiente al√©m das especificadas acima n√£o s√£o suportadas, pois n√£o s√£o esperadas pelo avaliador do projeto.**

<br />
</details>

<details>
  <summary><strong>üëÄ Dicas</strong></summary>

  #### Status HTTP

  Tenha em mente que todas as "respostas" devem respeitar os [status do protocolo HTTP](https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Status) com base no que o REST prega.

  Alguns exemplos:
  - Requisi√ß√µes que precisam de token mas n√£o o receberam devem retornar um c√≥digo de `status 401`;

  - Requisi√ß√µes que n√£o seguem o formato pedido pelo servidor devem retornar um c√≥digo de `status 400`;

  - Um problema inesperado no servidor deve retornar um c√≥digo de `status 500`;

  - Um acesso ao criar um recurso, no nosso caso usu√°rio ou post, deve retornar um c√≥digo de `status 201`.

</details>

<details>
  <summary  id="diagrama"><strong>üé≤ Diagrama ER e Entidades</strong></summary>

  #### Diagrama de Entidade-Relacionamento

  Para orientar a constru√ß√£o das tabelas atrav√©s do ORM, utilize o *DER* a seguir:

  ![DER](./public/der.png)

  ---

  #### Formato das entidades

  O seu projeto dever√° usar o `ORM Sequelize` para criar e atualizar o seu banco de dados. 

  Os primeiros requisitos do projeto devem orientar a produ√ß√£o de suas migrations para gerar:

  - Uma tabela chamada **Users**, contendo dados com a seguinte estrutura:

    ```json
    {
      "id": 1,
      "displayName": "Brett Wiltshire",
      "email": "brett@email.com", // tem quer ser √∫nico
      "password": "123456",
      "image": "http://4.bp.blogspot.com/_YA50adQ-7vQ/S1gfR_6ufpI/AAAAAAAAAAk/1ErJGgRWZDg/S45/brett.png"
    }
    ```
  - Uma tabela chamada **Categories**, contendo dados com a seguinte estrutura:

    ```json
    {
      "id": 18,
      "name": "News"
    }
    ```

  - Uma tabela chamada **BlogPosts**, contendo dados com a seguinte estrutura:

    ```json
    {
      "id": 21,
      "title": "Latest updates, August 1st",
      "content": "The whole text for the blog post goes here in this key",
      "userId": 14, // Chave estrangeira, referenciando o id de `Users`
      "published": "2011-08-01T19:58:00.000Z",
      "updated": "2011-08-01T19:58:51.947Z",
    }
    ```

  - Uma tabela chamada **PostCategories**, contendo uma **chave prim√°ria composta** utilizando os dois atributos da estrutura:

    ```json
    {
      "postId": 50, // Chave prim√°ria e estrangeira, referenciando o id de `BlogPosts`
      "categoryId": 20 // Chave prim√°ria e estrangeira, referenciando o id de `Categories`
    }
    ```
    *Os dados acima s√£o fict√≠cios, e est√£o aqui apenas como exemplo*

    > :warning:Ô∏è Em caso de d√∫vidas, consulte os conte√∫dos:
    > - [Transformando ideias em um modelo de banco de dados](https://app.betrybe.com/course/back-end/funcoes-sql-joins-e-normalizacao/transformando-ideias-em-um-modelo-de-banco-de-dados/a7326a61-117a-4d2f-a640-9e312b6f973b) *(Em `Database Design - Como modelar um banco de dados` > `4) Criando e modelando tabelas de acordo com um diagrama ER`)*
    > - [ORM - Interface da aplica√ß√£o com o banco de dados](https://app.betrybe.com/course/back-end/nodejs-orm-autenticacao/orm-interface-da-aplicacao-com-o-banco-de-dados/d0fc385e-b0ce-4b3d-8246-779d5dc13682) *(Em `Migra√ß√µes`)*
    > - [ORM - Associations](https://app.betrybe.com/course/back-end/nodejs-orm-autenticacao/orm-associations/043e2e8a-c28e-4b95-a949-b7c43221ca8d) *(Em `Relacionamentos N:N`)*  

    ---

    #### Dicas de scripts prontos

    - Deleta o banco de dados:
    ```json
    "drop": "npx sequelize-cli db:drop"
    ```

    - Cria o banco e gera as tabelas:
    ```json
    "prestart": "npx sequelize-cli db:create && npx sequelize-cli db:migrate"
    ```

    - Insere dados/Popula a tabela:
    ```json
    "seed": "npx sequelize-cli db:seed:all"
    ```

    **:eyes: OBS**: Os testes ir√£o rodar atrav√©s do seu migrate usando os scripts acima, tamb√©m listados no `package.json`.

    **‚ö†Ô∏è Preste bastante aten√ß√£o, pois a altera√ß√£o desses scripts pode impedir o avaliador de funcionar corretamente**

    **:warning:Ô∏è Haver√° um arquivo na pasta `/seeders`, que ir√° conter as queries para inser√ß√£o no banco de dados. `N√£o a remova, pois o avaliador depende dela`.**

<br />
</details>

<details>
  <summary><strong>üó£ Me d√™ feedbacks sobre o projeto!</strong></summary>

  :warning: **O avaliador autom√°tico n√£o necessariamente avalia seu projeto na ordem em que os requisitos aparecem no readme. Isso acontece para deixar o processo de avalia√ß√£o mais r√°pido. Ent√£o, n√£o se assuste se isso acontecer, ok?**

<br />
</details>


